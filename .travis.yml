language: php
env:
  - DBVERSION=2019 TEST_SUITE=KernelTestAD,KernelTestKZ,sqlsrv,passing_database DRUPAL=yes CODE_SNIFF=yes
  - DBVERSION=2019 TEST_SUITE=KernelTestE,KernelTestF,KernelTestH,KernelTestI
  - DBVERSION=2019 TEST_SUITE=failing_database

php:
  - '7.2'
  - '7.3'

before_install:
  # Use pcov instead of xdebug
  - phpenv config-rm xdebug.ini
  - pecl channel-update pecl.php.net
  # Install SQL Server for Linux
  - wget -qO- https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
  - sudo add-apt-repository "$(wget -qO- https://packages.microsoft.com/config/ubuntu/16.04/mssql-server-$DBVERSION.list)"
  - sudo add-apt-repository "$(wget -qO- https://packages.microsoft.com/config/ubuntu/16.04/prod.list)"
  - sudo apt-get update
  - sudo ACCEPT_EULA=Y apt-get install -y mssql-server mssql-tools unixodbc-dev
  - export MSSQL_SA_PASSWORD=Password12!
  - export ACCEPT_EULA=Y
  - export MSSQL_PID=Evaluation
  - sudo /opt/mssql/bin/mssql-conf setup
  - sleep 15
  - /opt/mssql-tools/bin/sqlcmd -P Password12! -S localhost -U SA -Q 'CREATE DATABASE mydrupalsite COLLATE LATIN1_GENERAL_100_CI_AS_SC_UTF8'
  # Install the pdo_sqlsrv extension
  - sudo ACCEPT_EULA=Y apt-get -y install msodbcsql17 unixodbc-dev gcc g++ make autoconf libc-dev pkg-config
  - pecl install pcov sqlsrv pdo_sqlsrv
  - phpenv config-add install/travis-7.x.ini
install:
  # Create a Drupal Site
  - cd ..
  - export COMPOSER_MEMORY_LIMIT=-1
  - |
    if [ "${DRUPAL_VERSION}" == "9.0" ]; then
      composer -n create-project drupal/recommended-project:^9.0@dev drupal-project
      cd drupal-project
      composer require drush/drush phpunit/phpunit:^8
      mkdir ./web/modules/contrib
      cd $TRAVIS_BUILD_DIR/../drupal-project/web
      wget https://www.drupal.org/files/issues/2020-02-11/2867788-71.patch
      git apply 2867788-71.patch
    else
      composer create-project -n drupal-composer/drupal-project:8.x-dev
      cd drupal-project
      composer config repositories.drupal composer https://packages.drupal.org/8
      composer require drupal/sqlsrv:dev-1.x@dev symfony/psr-http-message-bridge:1.1.x-dev php-coveralls/php-coveralls:^2.0
      composer require pcov/clobber --dev
      cp -r $TRAVIS_BUILD_DIR/drivers ./web/drivers
      rm -rf ./web/modules/contrib/sqlsrv
      cp -rf $TRAVIS_BUILD_DIR ./web/modules/contrib/sqlsrv
      PATH=$PATH:$TRAVIS_BUILD_DIR/../drupal-project/vendor/bin
      mkdir $TRAVIS_BUILD_DIR/../drupal-project/web/sites/simpletest
      # Install patches
      cd $TRAVIS_BUILD_DIR/../drupal-project/web
      wget https://www.drupal.org/files/issues/2020-02-22/2867788-79.patch
      wget https://www.drupal.org/files/issues/2020-02-14/drupal-3113403-Make_condition_driver_overridable-14.patch
      git apply 2867788-79.patch
      git apply drupal-3113403-Make_condition_driver_overridable-14.patch
      wget https://www.drupal.org/files/issues/2020-01-30/drupal-3108540-deprecationErrors-3.patch
      wget https://www.drupal.org/files/issues/2020-02-25/3108540-11.patch
      wget https://www.drupal.org/files/issues/2020-02-05/drupal-3111134-database_specific_types-3.patch
      git apply drupal-3108540-deprecationErrors-3.patch
      git apply drupal-3111134-database_specific_types-3.patch
      git apply 3108540-11.patch
      cd ..
      pcov clobber
    fi
  - |
    if ! [ -z "$DRUPAL" ]; then
      drupal site:install standard --langcode="en" --db-type="sqlsrv" --db-host="localhost" --db-name="mydrupalsite" --db-user="sa" --db-pass="Password12!" --db-port="1433" --site-name="SQL Server Drupal Site" --site-mail="admin@example.com" --account-name="admin" --account-mail="admin@example.com" --account-pass="admin" --no-interaction
    fi
  # Install REGEX CLR
  - sudo apt-get install -qq mono-complete
  - cd $TRAVIS_BUILD_DIR/tests
  - mcs -reference:System.Data.dll -target:library -out:RegEx.dll regex.cs
  - sudo mv RegEx.dll /var/opt/mssql/data/
  - /opt/mssql-tools/bin/sqlcmd -P Password12! -S localhost -U SA -d mydrupalsite -Q "EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'clr strict security', 0; RECONFIGURE; EXEC sp_configure 'clr enable', 1; RECONFIGURE"
  - /opt/mssql-tools/bin/sqlcmd -P Password12! -S localhost -U SA -d mydrupalsite -Q "CREATE ASSEMBLY Regex from '/var/opt/mssql/data/RegEx.dll' WITH PERMISSION_SET = SAFE"
  - /opt/mssql-tools/bin/sqlcmd -P Password12! -S localhost -U SA -d mydrupalsite -Q "CREATE FUNCTION dbo.REGEXP(@pattern NVARCHAR(100), @matchString NVARCHAR(100)) RETURNS bit EXTERNAL NAME Regex.RegExCompiled.RegExCompiledMatch"
  - cd $TRAVIS_BUILD_DIR/../drupal-project
script:
  - cp $TRAVIS_BUILD_DIR/tests/phpunit.xml.dist $TRAVIS_BUILD_DIR/../drupal-project/web/core/phpunit.xml
  - cd $TRAVIS_BUILD_DIR/../drupal-project/web
  - ../vendor/bin/phpunit -c core/phpunit.xml --testsuite=$TEST_SUITE --coverage-clover $TRAVIS_BUILD_DIR/build/logs/clover.xml
after_success:
  - |
    if ! [ -z "$CODE_SNIFF" ]; then
      phpcs --config-set installed_paths $TRAVIS_BUILD_DIR/../drupal-project/vendor/drupal/coder/coder_sniffer
      phpcs --standard=Drupal --extensions=php,module,inc,install,test,profile,theme,css,info,txt,md,yml modules/contrib/sqlsrv
    fi
  - cd $TRAVIS_BUILD_DIR
  - sed -i 's/drupal\-project\/web\/modules\/contrib\///g' ./build/logs/clover.xml
  - sed -i 's/drupal\-project\/web/sqlsrv/g' ./build/logs/clover.xml
  - php-coveralls -v
